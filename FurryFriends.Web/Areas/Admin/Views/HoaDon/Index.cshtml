@model IEnumerable<FurryFriends.API.Models.HoaDon>

@{
    ViewData["Title"] = "Quản lý hóa đơn";
}

<div class="top-bar" style="padding-left: 50px;">
    <h1>@ViewData["Title"]</h1>
    <div class="top-bar-actions">
    </div>
</div>
<nav aria-label="breadcrumb" class="mb-3" style="padding-left: 50px;">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a asp-area="Admin" asp-controller="Home" asp-action="Index">Trang chủ</a></li>
        <li class="breadcrumb-item active">Quản lý hóa đơn</li>
    </ol>
</nav>
<div class="container mb-4" id="filterContainer">
    <div class="card shadow-sm p-3 mb-3" style="border-radius: 12px;">
        <div class="row align-items-center mb-2">
            <div class="col-auto">
                <span class="fs-5 fw-semibold"><i class="fas fa-filter me-2"></i>Bộ lọc</span>
            </div>
        </div>
        <div class="row align-items-end g-3">
            <div class="col-md-3">
                <label for="filterTrangThai" class="form-label mb-1">Trạng thái</label>
                <select id="filterTrangThai" class="form-select">
                    <option value="">Tất cả</option>
                    <option value="Chờ xác nhận">Chờ xác nhận</option>
                    <option value="Đã xác nhận">Đã xác nhận</option>
                    <option value="Đang giao">Đang giao</option>
                    <option value="Hoàn thành">Hoàn thành</option>
                    <option value="Đã hủy">Đã hủy</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="filterNgayTu" class="form-label mb-1">Ngày tạo từ</label>
                <input type="date" id="filterNgayTu" class="form-control" />
            </div>
            <div class="col-md-3">
                <label for="filterNgayDen" class="form-label mb-1">Ngày tạo đến</label>
                <input type="date" id="filterNgayDen" class="form-control" />
            </div>
            <div class="col-md-3 d-flex flex-column justify-content-end">
                <label for="filterTongTienMin" class="form-label mb-1">Tổng tiền trong khoảng</label>
                <div class="d-flex align-items-center gap-2 w-100">
                    <div class="d-flex flex-column align-items-center" style="width: 54px;">
                        <img src="/images/catrage.jpg" alt="min" style="width:38px;height:38px;object-fit:contain;" class="mb-1" />
                    </div>
                    <div class="d-flex flex-column align-items-center flex-grow-1">
                        <input type="number" id="filterTongTienMin" class="form-control text-end" style="width:100%;min-width:90px;max-width:120px;" min="0" max="100000000" placeholder="Từ" />
                        <small id="minFormatted" class="text-primary mt-1" style="min-height:18px;"></small>
                    </div>
                    <span class="mx-1 fw-bold fs-4">-</span>
                    <div class="d-flex flex-column align-items-center flex-grow-1">
                        <input type="number" id="filterTongTienMax" class="form-control text-end" style="width:100%;min-width:90px;max-width:120px;" min="0" max="100000000" placeholder="Đến" />
                        <small id="maxFormatted" class="text-primary mt-1" style="min-height:18px;"></small>
                    </div>
                    <div class="d-flex flex-column align-items-center" style="width: 54px;">
                        <img src="/images/ragedog.png" alt="max" style="width:38px;height:38px;object-fit:contain;" class="mb-1" />
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="table-container table-responsive" id="hoaDonTableContainer" style="margin-left: 10px; margin-right: 40px;">
    <table id="hoaDonTable" class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>Mã hóa đơn</th>
                <th>Khách hàng</th>
                <th>Ngày tạo</th>
                <th>Tổng tiền</th>
                <th>Giảm giá</th>
                <th>Thành tiền</th>
                <th>Trạng thái</th>
                <th>Thao tác</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td>@item.HoaDonId.ToString().Substring(0, 8).ToUpper()</td>
                    <td>
                        <div>@item.TenCuaKhachHang</div>
                        <small class="text-muted">@item.SdtCuaKhachHang</small>
                    </td>
                    <td>@item.NgayTao.ToString("dd/MM/yyyy HH:mm")</td>
                    <td>@item.TongTien.ToString("N0")đ</td>
                    <td>
                        @if (item.Voucher != null)
                        {
                            <span class="badge bg-success">@item.Voucher.TenVoucher</span>
                        }
                        else
                        {
                            <span class="text-muted">Không có</span>
                        }
                    </td>
                    <td>@item.TongTienSauKhiGiam.ToString("N0")đ</td>
                    <td>
                        @switch (item.TrangThai)
                        {
                            case 0:
                                <span class="status-badge status-pending">Chờ xác nhận</span>
                                break;
                            case 1:
                                <span class="status-badge status-info">Đã xác nhận</span>
                                break;
                            case 2:
                                <span class="status-badge status-paid">Đang giao</span>
                                break;
                            case 3:
                                <span class="status-badge status-paid">Hoàn thành</span>
                                break;
                            case 4:
                                <span class="status-badge status-overdue">Đã hủy</span>
                                break;
                            default:
                                <span class="status-badge status-cancelled">Không xác định</span>
                                break;
                        }
                    </td>
                    <td>
                        <div class="d-flex gap-2">
                            <a href="@Url.Action("Details", "HoaDon", new { area = "Admin", id = item.HoaDonId })" class="btn btn-info btn-sm action-btn">
                                <i class="fas fa-eye"></i>
                            </a>
                            <a href="@Url.Action("ExportPdf", "HoaDon", new { area = "Admin", id = item.HoaDonId })" class="btn btn-success btn-sm action-btn" target="_blank">
                                <i class="fas fa-file-pdf"></i>
                            </a>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<style>
    .pet-range-slider input[type=range] {
        -webkit-appearance: none;
        width: 100%;
        background: transparent;
        pointer-events: all;
    }
    .pet-range-slider input[type=range]:focus {
        outline: none;
    }
    .pet-range-slider input[type=range]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 40px;
        height: 40px;
        background: transparent;
        border: none;
        box-shadow: none;
        cursor: pointer;
    }
    .pet-range-slider input[type=range]::-moz-range-thumb {
        width: 40px;
        height: 40px;
        background: transparent;
        border: none;
        box-shadow: none;
        cursor: pointer;
    }
    .pet-range-slider input[type=range]::-ms-thumb {
        width: 40px;
        height: 40px;
        background: transparent;
        border: none;
        box-shadow: none;
        cursor: pointer;
    }
    .pet-range-slider input[type=range]::-webkit-slider-runnable-track {
        height: 8px;
        background: transparent;
    }
    .pet-range-slider input[type=range]::-ms-fill-lower,
    .pet-range-slider input[type=range]::-ms-fill-upper {
        background: transparent;
    }
    /* Hiệu ứng dấu chân động vật giữa 2 pet */
    #petTrack.pet-paw {
        background-image: repeating-linear-gradient(90deg, #4A90E2 0 8px, transparent 8px 16px), url('/images/pawprint.png');
        background-size: 16px 8px, 32px 16px;
        background-repeat: repeat-x;
    }
</style>
@section Scripts {
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.3.3/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/2.3.2/js/dataTables.js"></script>
    <script src="https://cdn.datatables.net/2.3.2/js/dataTables.bootstrap5.js"></script>
    <script>
        $(document).ready(function () {
            if (window.adminLoading) {
                window.adminLoading.showTableLoading('#hoaDonTableContainer');
            }
            var table = $('#hoaDonTable').DataTable({
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/vi.json',
                    emptyTable: "Không có dữ liệu hóa đơn"
                },
                responsive: true,
                order: [[2, 'desc']],
                initComplete: function () {
                    if (window.adminLoading) {
                        window.adminLoading.hideTableLoading('#hoaDonTableContainer');
                    }
                }
            });
            // Fix colspan for empty table row (chỉ còn 1 <td colspan=8>)
            $('#hoaDonTable').on('draw.dt', function() {
                var $empty = $('#hoaDonTable tbody td.dt-empty');
                if ($empty.length) {
                    $empty.siblings('td').remove();
                    $empty.attr('colspan', 8);
                }
            });
            // Dual range slider tổng tiền
            var $min = $('#filterTongTienMin');
            var $max = $('#filterTongTienMax');
            var $minFmt = $('#minFormatted');
            var $maxFmt = $('#maxFormatted');
            function formatMoneyVN(val) {
                if (!val || isNaN(val)) return '';
                return parseInt(val).toLocaleString('vi-VN') + ' VNĐ';
            }
            function updateMoneyFormat() {
                $minFmt.text(formatMoneyVN($min.val()));
                $maxFmt.text(formatMoneyVN($max.val()));
            }
            $min.on('input change', function() { $("#hoaDonTable").DataTable().draw(); updateMoneyFormat(); });
            $max.on('input change', function() { $("#hoaDonTable").DataTable().draw(); updateMoneyFormat(); });
            updateMoneyFormat();
            // Custom search logic
            $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
                var trangThai = $('#filterTrangThai').val();
                var ngayTu = $('#filterNgayTu').val();
                var ngayDen = $('#filterNgayDen').val();
                var tongTienMin = parseInt($min.val()) || 0;
                var tongTienMax = parseInt($max.val()) || 100000000;
                var rowTrangThai = $(table.row(dataIndex).node()).find('td:eq(6)').text().trim();
                var rowNgay = data[2].split(' ')[0].split('/').reverse().join('-');
                var rowTongTien = parseInt(data[3].replace(/\D/g, ''));
                // Trạng thái
                if (trangThai && !rowTrangThai.includes(trangThai)) return false;
                // Ngày tạo
                if (ngayTu && rowNgay < ngayTu) return false;
                if (ngayDen && rowNgay > ngayDen) return false;
                // Tổng tiền trong khoảng
                if (rowTongTien < tongTienMin || rowTongTien > tongTienMax) return false;
                return true;
            });
        });
    </script>
    <link rel="stylesheet" href="https://cdn.datatables.net/2.3.2/css/dataTables.bootstrap5.min.css" />
}