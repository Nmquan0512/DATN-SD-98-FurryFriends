@model FurryFriends.API.Models.DTO.GioHangDTO
@{
    Layout = "_Layout";
    var selectedVoucherId = ViewBag.VoucherId as Guid?;
    var tienSauGiam = ViewBag.TienSauGiam as decimal?;
    var danhSachVouchers = ViewBag.Vouchers as IEnumerable<FurryFriends.API.Models.Voucher>;
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <title>Giỏ hàng của bạn</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        .cart-title { font-size: 2rem; font-weight: bold; color: #0d6efd; }
        .table td, .table th { vertical-align: middle; }
        .btn-outline-primary:hover { background-color: #0d6efd; color: white; }
        .btn-outline-danger:hover { background-color: #dc3545; color: white; }
    </style>
</head>
<body>
<div class="container py-5">
    <h2 class="text-center cart-title mb-5">🛒 Giỏ hàng của bạn</h2>

    @if (Model == null || Model.ChiTietGioHang == null || !Model.ChiTietGioHang.Any())
    {
        <div class="alert alert-info text-center shadow-sm p-4">
            <i class="bi bi-cart-x-fill fs-4 me-2"></i> Giỏ hàng của bạn đang trống.
        </div>
    }
    else
    {
        <!-- Voucher Form -->
        <form asp-action="Index" method="get" class="mb-4">
            <div class="row g-2 align-items-end">
                <div class="col-md-6">
                    <label for="voucherId" class="form-label fw-semibold">Áp dụng mã giảm giá:</label>
                    <select name="voucherId" id="voucherId" class="form-select">
                        <option value="">-- Chọn voucher --</option>
                            @foreach (var voucher in danhSachVouchers)
                            {
                                if (voucher.VoucherId == selectedVoucherId)
                                {
                                    <option value="@voucher.VoucherId" selected>
                                        @voucher.TenVoucher (@voucher.PhanTramGiam.ToString("0")% giảm)
                                    </option>
                                }
                                else
                                {
                                    <option value="@voucher.VoucherId">
                                        @voucher.TenVoucher (@voucher.PhanTramGiam.ToString("0")% giảm)
                                    </option>
                                }
                            }
                    </select>
                </div>
                <div class="col-md-auto">
                    <button type="submit" class="btn btn-primary">Áp dụng</button>
                </div>
            </div>
        </form>

        <!-- Table -->
        <div class="table-responsive shadow-sm">
            <table class="table table-bordered align-middle bg-white">
                <thead class="table-primary text-center">
                    <tr>
                        <th>Sản phẩm</th>
                        <th>Đơn giá</th>
                        <th>Số lượng</th>
                        <th>Thành tiền</th>
                        <th>Hành động</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.ChiTietGioHang)
                    {
                        <tr>
                            <td class="fw-semibold">@item.TenSanPham</td>
                            <td class="text-end">@item.DonGia.ToString("N0") đ</td>
                            <td>
                                    <form asp-action="UpdateQuantity" method="post" class="d-flex justify-content-center gap-2">
                                        <input type="hidden" name="chiTietId" value="@item.GioHangChiTietId" />
                                        <input type="hidden" name="voucherId" value="@selectedVoucherId" /> <!-- ✅ thêm dòng này -->
                                        <input type="number" name="soLuong" value="@item.SoLuong" min="1"
                                               class="form-control form-control-sm text-center" style="width: 70px;" />
                                        <button type="submit" class="btn btn-sm btn-outline-primary">Cập nhật</button>
                                    </form>
                            </td>
                            <td class="text-end text-danger fw-semibold">@item.ThanhTien.ToString("N0") đ</td>
                            <td class="text-center">
                                    <form asp-action="Remove" method="post" class="d-inline">
                                        <input type="hidden" name="chiTietId" value="@item.GioHangChiTietId" />
                                        <input type="hidden" name="voucherId" value="@selectedVoucherId" /> <!-- ✅ thêm dòng này -->
                                        <button type="button" class="btn btn-sm btn-outline-info mb-1" data-bs-toggle="modal" data-bs-target="#modalChiTiet-@item.GioHangChiTietId">
                                            <i class="bi bi-eye-fill"></i> Chi tiết
                                        </button>
                                        <button type="submit" class="btn btn-sm btn-outline-danger" title="Xóa sản phẩm">
                                            <i class="bi bi-trash3-fill"></i> Xóa
                                        </button>
                                    </form>

                                <!-- Modal -->
                                <div class="modal fade" id="modalChiTiet-@item.GioHangChiTietId" tabindex="-1" aria-labelledby="label-@item.GioHangChiTietId" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-centered modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header bg-info text-white">
                                                <h5 class="modal-title" id="label-@item.GioHangChiTietId">Chi tiết: @item.TenSanPham</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="row">
                                                    <div class="col-md-4 text-center">
                                                        <img src="@($"https://localhost:7289/images/{System.IO.Path.GetFileName(item.AnhSanPham)}")"
                                                             class="img-fluid rounded border" alt="Ảnh sản phẩm" />
                                                    </div>
                                                    <div class="col-md-8">
                                                        <p><strong>Màu sắc:</strong> @item.MauSac</p>
                                                        <p><strong>Kích cỡ:</strong> @item.KichCo</p>
                                                        <p><strong>Giá bán:</strong> @item.DonGia.ToString("N0") đ</p>
                                                        <p><strong>Số lượng:</strong> @item.SoLuong</p>
                                                        <p><strong>Thành tiền:</strong> <span class="text-danger fw-bold">@item.ThanhTien.ToString("N0") đ</span></p>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
                <tfoot class="table-light">
                    <tr>
                        <td colspan="3" class="text-end fw-bold fs-5">Tổng cộng:</td>
                        <td colspan="2" class="text-danger fw-bold fs-5">@Model.TongTien.ToString("N0") đ</td>
                    </tr>
                    @if (tienSauGiam.HasValue)
                    {
                        <tr>
                            <td colspan="3" class="text-end fw-bold fs-5">Tổng sau giảm:</td>
                            <td colspan="2" class="text-success fw-bold fs-5">@tienSauGiam.Value.ToString("N0") đ</td>
                        </tr>
                    }
                </tfoot>
            </table>
        </div>

            <form asp-controller="GioHangs" asp-action="ThanhToan" method="post" class="text-end mt-4">
                <input type="hidden" name="KhachHangId" value="@Context.Session.GetString("KhachHangId")" />
                <input type="hidden" name="VoucherId" value="@selectedVoucherId" />

                <div class="row mb-3 text-start">
                    <div class="col-md-12">
                        <label for="HinhThucThanhToanId" class="form-label fw-semibold">Chọn hình thức thanh toán:</label>
                        <select name="HinhThucThanhToanId" id="HinhThucThanhToanId" class="form-select" required>
                            <option value="">-- Vui lòng chọn --</option>
                            @foreach (var hinhThuc in ViewBag.HinhThucThanhToanList as IEnumerable<FurryFriends.API.Models.HinhThucThanhToan>)
                            {
                                <option value="@hinhThuc.HinhThucThanhToanId">@hinhThuc.TenHinhThuc</option>
                            }
                        </select>
                    </div>
                </div>

                <button type="submit" class="btn btn-success btn-lg px-4 shadow">
                    <i class="bi bi-credit-card-fill"></i> Tiến hành thanh toán
                </button>
            </form>



    }
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
